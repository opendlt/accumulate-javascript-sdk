{{- define "protocol"}}// DO NOT EDIT. Generated by generate-sdk.sh.
{{- template "imports"}}
import { TransactionType, KeyPageOperation } from "./enums";

{{- template "types" .}}
{{- end}}

{{- define "state"}}// DO NOT EDIT. Generated by generate-sdk.sh.
{{- template "imports"}}

{{- template "types" .}}

export type Object = AccObject;
{{- end}}

{{- define "imports"}}
import BN from "bn.js";
import { AccURL } from "../acc-url";
import { BasePayload } from "../payload/base-payload";
import {
  arrayMarshalBinary,
  bigNumberMarshalBinary,
  booleanMarshalBinary,
  bytesMarshalBinary,
  hashMarshalBinary,
  stringMarshalBinary,
  uvarintMarshalBinary,
} from "../encoding";
{{- end}}

{{- define "types"}}
{{- range .Types}}

export type {{.Name}}Arg = {{if or .Fields .Embeddings .IsChain}}{
  {{- if .IsChain}}
  url: string | AccURL;
  keyBook: string | AccURL;
  managerKeyBook: string | AccURL;
  {{- end}}
  {{- range .Embeddings}}
  {{- range .Fields}}
  {{lcName .Name}}: {{template "argType" .}};
  {{- end}}
  {{- end}}
  {{- range .Fields}}
  {{lcName .Name}}: {{template "argType" .}};
  {{- end}}
}{{else}}unknown{{end}};

export class {{.Name}} {{if (and .IsBinary (not .IsChain))}}extends BasePayload {{end}}{
  {{- if .IsChain}}
  public readonly url: AccURL;
  public readonly keyBook: AccURL;
  public readonly managerKeyBook: AccURL;
  {{- end}}
  {{- range .Embeddings}}
  {{- range .Fields}}
  public readonly {{lcName .Name}}: {{template "varType" .}};
  {{- end}}
  {{- end}}
  {{- range .Fields}}
  public readonly {{lcName .Name}}: {{template "varType" .}};
  {{- end}}

  constructor({{if or .Fields .Embeddings .IsChain}}arg{{else}}_{{end}}: {{.Name}}Arg) {
    {{- if (and .IsBinary (not .IsChain))}}
    super();
    {{- end}}
    {{- if .IsChain}}
    this.url = AccURL.toAccURL(arg.url);
    this.keyBook = AccURL.toAccURL(arg.keyBook);
    this.managerKeyBook = AccURL.toAccURL(arg.managerKeyBook);
    {{- end}}
    {{- range .Embeddings}}
    {{- range .Fields}}
    this.{{lcName .Name}} = {{template "convertArg" .}};
    {{- end}}
    {{- end}}
    {{- range .Fields}}
    this.{{lcName .Name}} = {{template "convertArg" .}};
    {{- end}}
  }

  {{- if (and .IsBinary (not .IsChain))}}
  protected _marshalBinary(): Buffer {
    return Buffer.concat([
      {{- if .IsTransaction}}
      uvarintMarshalBinary(TransactionType.{{.TransactionType}}),
      {{- end}}
      {{- range .Embeddings}}
      {{- range .Fields}}
      {{template "marshalField" map "Field" . "Src" (print "this." (lcName .Name))}},
      {{- end}}
      {{- end}}
      {{- range .Fields}}
      {{template "marshalField" map "Field" . "Src" (print "this." (lcName .Name))}},
      {{- end}}
    ]);
  }
  {{- end}}
}
{{- end}}
{{- end}}

{{- define "varType"}}
{{- if eq .Type "url.URL"}}AccURL
{{- else if eq .Type "bytes"}}Uint8Array
{{- else if eq .Type "chain"}}Uint8Array
{{- else if eq .Type "chainSet"}}Uint8Array[]
{{- else if eq .Type "bool"}}boolean
{{- else if eq .Type "varint"}}number
{{- else if eq .Type "uvarint"}}number
{{- else if eq .Type "bigint"}}BN
{{- else if eq .Type "rawJson"}}unknown
{{- else if eq .Type "duration"}}number
{{- else if eq .Type "slice"}}{{template "varType" .Slice}}[]
{{- else}}{{.Type}}
{{- end}}
{{- end}}

{{- define "argType"}}
{{- if eq .Type "url.URL"}}string | AccURL
{{- else if eq .Type "bytes"}}Uint8Array
{{- else if eq .Type "chain"}}Uint8Array
{{- else if eq .Type "chainSet"}}Uint8Array[]
{{- else if eq .Type "bool"}}boolean
{{- else if eq .Type "varint"}}number
{{- else if eq .Type "uvarint"}}number
{{- else if eq .Type "bigint"}}number | BN | string
{{- else if eq .Type "rawJson"}}unknown
{{- else if eq .Type "duration"}}number | string | { seconds: number, nanoseconds: number }
{{- else if eq .Type "slice"}}{{template "argType" .Slice}}[]
{{- else}}{{.Type}}
{{- end}}
{{- end}}

{{- define "convertArg"}}
{{- if eq .Type "url.URL"}}AccURL.toAccURL(arg.{{lcName .Name}})
{{- else if eq .Type "bigint"}}arg.{{lcName .Name}} instanceof BN ? arg.{{lcName .Name}} : new BN(arg.{{lcName .Name}})
{{- else if eq .Type "duration"}}typeof arg.{{lcName .Name}} === "object" ? arg.{{lcName .Name}}.seconds + arg.{{lcName .Name}}.nanoseconds/1e9 : Number(arg.{{lcName .Name}})
{{- else}}arg.{{lcName .Name}}
{{- end}}
{{- end}}

{{- define "marshalField"}}
{{- if eq .Field.Type "url.URL"}}stringMarshalBinary({{.Src}}.toString())
{{- else if eq .Field.Type "bigint"}}bigNumberMarshalBinary({{.Src}})
{{- else if eq .Field.Type "bool"}}booleanMarshalBinary({{.Src}})
{{- else if eq .Field.Type "chain"}}hashMarshalBinary({{.Src}})
{{- else if eq .Field.Type "rawJson"}}stringMarshalBinary(JSON.stringify({{.Src}}))
{{- else if eq .Field.Type "slice"}}arrayMarshalBinary({{.Src}}, (val) => {{template "marshalField" map "Field" .Field.Slice "Src" "val"}})
{{- else if eq .Field.Type "ChainType"}}uvarintMarshalBinary({{.Src}})
{{- else if eq .Field.Type "KeyPageOperation"}}uvarintMarshalBinary({{.Src}})
{{- else if eq .Field.Type "ObjectType"}}uvarintMarshalBinary({{.Src}})
{{- else if .Field.AsReference}}{{.Src}}.marshalBinary()
{{- else if .Field.AsValue}}{{.Src}}.marshalBinary()
{{- else}}{{.Field.Type}}MarshalBinary({{.Src}})
{{- end}}
{{- end}}
