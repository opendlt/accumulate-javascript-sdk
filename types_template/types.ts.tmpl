{{- define "protocol"}}// DO NOT EDIT. Generated by generate-sdk.sh.
{{- template "imports"}}
import { TransactionType, KeyPageOperation } from "./enums";

/* eslint-disable @typescript-eslint/no-namespace,no-constant-condition */

export type TransactionBody =
{{- range $i, $t := .Types}}
{{- if .IsTransaction}}
  | {{$t.Name}}
{{- end}}
{{- end}};

type TransactionPayload = TransactionBody;

export namespace TransactionBody {
  export function from(arg: unknown): TransactionBody {
    const { type } = <{ type: string }>arg;
    switch (TransactionType.byName(type)) {
      {{- range .Types}}
      {{- if .IsTransaction}}
      case TransactionType.{{.Name}}:
        return new {{.Name}}(<{{.Name}}Arg>arg);
      {{- end}}
      {{- end}}
      default:
        throw new Error(`Unknown TransactionType '${type}'`);
    }
  }
}

{{- template "types" .}}
{{- end}}

{{- define "state"}}// DO NOT EDIT. Generated by generate-sdk.sh.
{{- template "imports"}}

{{- template "types" .}}

export type Object = AccObject;
{{- end}}

{{- define "imports"}}
import BN from "bn.js";
import { AccURL } from "../acc-url";
import { BasePayload } from "../payload/base-payload";
import {
  marshalField,
  bigNumberMarshalBinary,
  booleanMarshalBinary,
  bytesMarshalBinary,
  hashMarshalBinary,
  stringMarshalBinary,
  uvarintMarshalBinary,
} from "../encoding";
{{- end}}

{{- define "types"}}
{{- range .Types}}

export type {{.Name}}Arg = {{if or .Fields .Embeddings .IsChain}}{
  {{- if .IsChain}}
  url: string | AccURL;
  keyBook?: string | AccURL;
  managerKeyBook?: string | AccURL;
  {{- end}}
  {{- range .Embeddings}}
  {{- range .Fields}}
  {{- if .IsMarshalled}}
  {{lcName .Name}}{{if .IsOptional}}?{{end}}: {{template "argType" .}};
  {{- end}}
  {{- end}}
  {{- end}}
  {{- range .Fields}}
  {{- if .IsMarshalled}}
  {{lcName .Name}}{{if .IsOptional}}?{{end}}: {{template "argType" .}};
  {{- end}}
  {{- end}}
}{{else}}unknown{{end}};

export class {{.Name}} {{if and .IsBinary (not .IsChain)}}extends BasePayload {{end}}{
  {{- if .IsChain}}
  public readonly url: AccURL;
  public readonly keyBook?: AccURL;
  public readonly managerKeyBook?: AccURL;
  {{- end}}
  {{- range .Embeddings}}
  {{- range .Fields}}
  {{- if .IsMarshalled}}
  public readonly {{lcName .Name}}{{if .IsOptional}}?{{end}}: {{template "varType" .}};
  {{- end}}
  {{- end}}
  {{- end}}
  {{- range .Fields}}
  {{- if .IsMarshalled}}
  public readonly {{lcName .Name}}{{if .IsOptional}}?{{end}}: {{template "varType" .}};
  {{- end}}
  {{- end}}

  constructor({{if or .Fields .Embeddings .IsChain}}arg{{else}}_{{end}}: {{.Name}}Arg) {
    {{- if (and .IsBinary (not .IsChain))}}
    super();
    {{- end}}
    {{- if .IsChain}}
    this.url = AccURL.toAccURL(arg.url);
    this.keyBook = AccURL.toAccURL(arg.keyBook);
    this.managerKeyBook = AccURL.toAccURL(arg.managerKeyBook);
    {{- end}}
    {{- range .Embeddings}}
    {{- range .Fields}}
    {{- if .IsMarshalled}}
    {{- if .IsOptional}}if (arg.{{lcName .Name}}){{end}}
    this.{{lcName .Name}} = {{template "convertArg" .}};
    {{- end}}
    {{- end}}
    {{- end}}
    {{- range .Fields}}
    {{- if .IsMarshalled}}
    {{- if .IsOptional}}if (arg.{{lcName .Name}}){{end}}
    this.{{lcName .Name}} = {{template "convertArg" .}};
    {{- end}}
    {{- end}}
  }

  {{- if (and .IsBinary (not .IsChain))}}
  protected _marshalBinary(): Buffer {
    const parts = [];
    {{- if .IsTransaction}}
    parts.push(marshalField(1, uvarintMarshalBinary(TransactionType.{{.TransactionType}})));
    {{- end}}
    {{- range .Embeddings}}
    {
      const subParts = [];
      {{- range .Fields}}
      {{- if .IsMarshalled}}
      if ({{template "isSet" map "Field" . "Src" (print "this." (lcName .Name))}}) {
        subParts.push({{template "marshalField" map "Field" . "Src" (print "this." (lcName .Name))}});
      }
      {{- end}}
      {{- end}}
      parts.push(marshalField(1, bytesMarshalBinary(Buffer.concat(subParts))));
    }
    {{- end}}
    {{- range .Fields}}
    {{- if .IsMarshalled}}
    if ({{template "isSet" map "Field" . "Src" (print "this." (lcName .Name))}}) {
      parts.push({{template "marshalField" map "Field" . "Src" (print "this." (lcName .Name))}});
    }
    {{- end}}
    {{- end}}
    return Buffer.concat(parts);
  }
  {{- end}}
}
{{- end}}
{{- end}}

{{- define "varType"}}
{{-      if eq .Type "url"     }}AccURL
{{- else if eq .Type "bytes"   }}Uint8Array
{{- else if eq .Type "chain"   }}Uint8Array
{{- else if eq .Type "bool"    }}boolean
{{- else if eq .Type "varint"  }}number | BN
{{- else if eq .Type "uvarint" }}number | BN
{{- else if eq .Type "int"     }}number | BN
{{- else if eq .Type "uint"    }}number | BN
{{- else if eq .Type "bigint"  }}BN
{{- else if eq .Type "rawJson" }}unknown
{{- else if eq .Type "duration"}}number
{{- else                       }}{{.Type}}
{{- end}}
{{- if .Repeatable}}[]{{end}}
{{- end}}

{{- define "argType"}}
{{- if .Repeatable}}({{end}}
{{-      if eq .Type "url"     }}string | AccURL
{{- else if eq .Type "bytes"   }}Uint8Array | string
{{- else if eq .Type "chain"   }}Uint8Array | string
{{- else if eq .Type "bool"    }}boolean
{{- else if eq .Type "varint"  }}number | BN
{{- else if eq .Type "uvarint" }}number | BN
{{- else if eq .Type "int"     }}number | BN
{{- else if eq .Type "uint"    }}number | BN
{{- else if eq .Type "bigint"  }}number | BN | string
{{- else if eq .Type "rawJson" }}unknown
{{- else if eq .Type "duration"}}number | string | { seconds: number, nanoseconds: number }
{{- else if .AsReference       }}{{.Type}} | {{.Type}}Arg
{{- else if .AsEnum            }}{{.Type}} | string
{{- else                       }}{{.Type}}
{{- end}}
{{- if .Repeatable}})[]{{end}}
{{- end}}

{{- define "convertArg"}}
{{- if .Repeatable}}arg.{{lcName .Name}}.map(v => {{template "_convertArg" map "Field" . "Arg" "v"}})
{{- else}}{{template "_convertArg" map "Field" . "Arg" (print "arg." (lcName .Name))}}
{{- end}}
{{- end}}

{{- define "_convertArg"}}
{{-      if eq .Field.Type "url"     }}AccURL.toAccURL({{.Arg}})
{{- else if eq .Field.Type "bigint"  }}{{.Arg}} instanceof BN ? {{.Arg}} : new BN({{.Arg}})
{{- else if eq .Field.Type "bytes"   }}typeof {{.Arg}} === "string" ? Buffer.from({{.Arg}}, "hex") : {{.Arg}}
{{- else if eq .Field.Type "chain"   }}typeof {{.Arg}} === "string" ? Buffer.from({{.Arg}}, "hex") : {{.Arg}}
{{- else if eq .Field.Type "duration"}}typeof {{.Arg}} === "object" ? {{.Arg}}.seconds + {{.Arg}}.nanoseconds/1e9 : Number({{.Arg}})
{{- else if .Field.AsReference       }}{{.Arg}} instanceof {{.Field.Type}} ? {{.Arg}} : new {{.Field.Type}}({{.Arg}})
{{- else if .Field.AsEnum            }}typeof {{.Arg}} === "string" ? {{.Field.Type}}.byName({{.Arg}}) : {{.Arg}}
{{- else                             }}{{.Arg}}
{{- end}}
{{- end}}

{{- define "isSet"}}
{{- if .Field.IsOptional}}{{.Src}} !== undefined && {{.Src}} !== null{{else}}true{{end}}
{{-      if .Field.Repeatable        }} && {{.Src}}.length > 0
{{- else if eq .Field.Type "url"     }}
{{- else if eq .Field.Type "bytes"   }} && {{.Src}}.length > 0
{{- else if eq .Field.Type "string"  }} && {{.Src}}.length > 0
{{- else if eq .Field.Type "chain"   }} && {{.Src}}.length > 0 && {{.Src}}.some(v => v !== 0)
{{- else if eq .Field.Type "bool"    }} && {{.Src}} === true
{{- else if eq .Field.Type "varint"  }} && ({{.Src}} instanceof BN ? !{{.Src}}.isZero() : {{.Src}} !== 0)
{{- else if eq .Field.Type "uvarint" }} && ({{.Src}} instanceof BN ? !{{.Src}}.isZero() : {{.Src}} !== 0)
{{- else if eq .Field.Type "int"     }} && ({{.Src}} instanceof BN ? !{{.Src}}.isZero() : {{.Src}} !== 0)
{{- else if eq .Field.Type "uint"    }} && ({{.Src}} instanceof BN ? !{{.Src}}.isZero() : {{.Src}} !== 0)
{{- else if eq .Field.Type "bigint"  }} && !{{.Src}}.isZero()
{{- else if eq .Field.Type "rawJson" }}
{{- else if eq .Field.Type "duration"}} && {{.Src}} !== 0
{{- end}}
{{- end}}

{{- define "marshalField"}}
{{- if .Field.Repeatable}}Buffer.concat({{.Src}}.map((val) => {{template "_marshalField" map "Field" .Field "Src" "val"}}))
{{- else}}{{template "_marshalField" .}}
{{- end}}
{{- end}}

{{- define "_marshalField"}}
{{-      if eq .Field.Type "url"             }}marshalField({{.Field.Number}}, stringMarshalBinary({{.Src}}.toString()))
{{- else if eq .Field.Type "bigint"          }}marshalField({{.Field.Number}}, bigNumberMarshalBinary({{.Src}}))
{{- else if eq .Field.Type "bool"            }}marshalField({{.Field.Number}}, booleanMarshalBinary({{.Src}}))
{{- else if eq .Field.Type "int"             }}marshalField({{.Field.Number}}, varintMarshalBinary({{.Src}}))
{{- else if eq .Field.Type "uint"            }}marshalField({{.Field.Number}}, uvarintMarshalBinary({{.Src}}))
{{- else if eq .Field.Type "chain"           }}marshalField({{.Field.Number}}, hashMarshalBinary({{.Src}}))
{{- else if eq .Field.Type "rawJson"         }}marshalField({{.Field.Number}}, stringMarshalBinary(JSON.stringify({{.Src}})))
{{- else if .Field.AsReference               }}marshalField({{.Field.Number}}, bytesMarshalBinary({{.Src}}.marshalBinary()))
{{- else if .Field.AsValue                   }}marshalField({{.Field.Number}}, bytesMarshalBinary({{.Src}}.marshalBinary()))
{{- else if .Field.AsEnum                    }}marshalField({{.Field.Number}}, uvarintMarshalBinary({{.Src}}))
{{- else                                     }}marshalField({{.Field.Number}}, {{.Field.Type}}MarshalBinary({{.Src}}))
{{- end}}
{{- end}}
